---

#- debug: msg="{{ lookup('env','HOME') }} is an environment variable"
  - name: Provision Fresh Manjaro
    hosts: manjaroPC
    vars:
      user:
        name: mar2
        pass : 123
    roles:
        - kewlfft.aur
    tasks:

      - name: Installing packages
        pacman: 
          name:
            - networkmanager
            - xwallpaper
            - gnome-keyring
            - neovim
            - compton
            - sudo
            - git
            - dmenu
            - freetype2
            - libx11
            - libxft
            - libxinerama
            - ttf-linux-libertine
            - libxext
              #- xorg-fonts-misc
              #- xorg
            - ranger
            - sxhkd
            - xorg-xinit
            - tree
            - bash-completion
            - chromium
            - qutebrowser
            - firefox
            - mpv
            - mpd
            - unrar
            - unzip
            - newsboat
            - htop
            - mpc
            - openssh
            - zsh
            - nextcloud-client
            - unclutter
            - seahorse
            - arandr
            - zathura
            - mupdf
            - tmux
            - dunst
            - fzf
            - highlight
            - w3m
            - chafa
            - atool
            - mediainfo
              #- pdftotxt
              #- otd2txt
            - sxiv
            - youtube-dl
            - redshift
            - clipmenu
            - emacs
            - noto-fonts
          state: present
        become: yes

      - name: install packages from aur
        aur:
          name:
            - lf-bin
            - font-symbola
            - zsh-fast-syntax-highlighting
          state: present
          use: yay

      - name: Add a new user named devops
        user:
          name: devops
          shell: /bin/zsh
          password: "{{ lookup('env','SETPASS') }}"
        become: yes

      - name: Add devops user to the sudoers
        become: yes
        copy:
          dest: "/etc/sudoers.d/devops"
          content: "devops  ALL=(ALL)  NOPASSWD: ALL"

      - name: Deploy SSH Key
        become: yes
        authorized_key: 
          user=devops
          state=present
          key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"


      - name: clone dwm
        become: yes
        become_user: devops
        ignore_errors: yes
        git:
          repo: "{{item.url}}"
          dest: "~/.local/src/{{item.folder}}"
        loop:
            - { url: "https://github.com/marnyg/dwm2.git", folder: "dwm"}
            - { url: "https://github.com/marnyg/st2.git", folder: "st"}
            - { url: "https://github.com/marnyg/dotfilesArch.git", folder: "dotfilesArch"}

      - name: make and install dwm src from git
        become: yes
        become_user: devops
        make:
          chdir: ~/.local/src/dwm/

      - name: make and install dwm src from git
        become: yes
        make:
          chdir: /home/devops/.local/src/dwm/
          target: install

      - name: make and install st src from git
        become: yes
        become_user: devops
        make:
          chdir: ~/.local/src/st/

      - name: make and install st src from git
        become: yes
        make:
          chdir: /home/devops/.local/src/st/
          target: install

      - name: run dotfiles init script
        become: yes
        become_user: devops
        command: 
          chdir: /home/devops/.local/src/dotfilesArch/
          cmd: ./initScript

      - name: fix problem with lf not reading config if it is a symlink
        become: yes
        become_user: devops
        command: 
          chdir: /home/devops/.config/lf
          cmd: cp ./scope ./scope1

      - name: run PlugInstall in vim
        become: yes
        become_user: devops
        ignore_errors: yes
        command: 
          cmd: vim +PlugInstall +qall --headless
          
          #      - name: set up pam to start gnome keyring at login
          #        become: yes
          #        pamd:
          #          name: login
          #          type: auth
          #          control: include
          #          module_path: system-local-login
          #          new_type: auth
          #          new_control: optional
          #          new_module_path: pam_gnome_keyring.so
          #          state: after
          #
          #      - name: set up pam to start gnome keyring at login
          #        become: yes
          #        pamd:
          #          name: login
          #          type: session
          #          control: include
          #          module_path: system-local-login
          #          new_type: session
          #          new_control: optional
          #          new_module_path: pam_gnome_keyring.so
          #          state: after
          #          module_arguments: auto_start

      - name: install ohmyzsh
        become: yes
        become_user: devops
        git:
          repo: https://github.com/ohmyzsh/ohmyzsh
          dest: ~/.config/oh-my-zsh

      - name: Clean artifact path
        become: yes
        become_user: devops
        file:
          state: absent
          path: "{{item}}"
        loop:
            - ~/Desktop
            - ~/Documents
            - ~/Music
            - ~/Pictures
            - ~/Templates
            - ~/Videos
            - ~/Public

              #      - name: remove user named devops
              #        become: yes
              #        user:
              #          name: devops
              #          password: "{{ lookup('env','test') }}"
              #          state: absent
              #          remove: yes
              #        tags: r
